```{r myPlot}
myPlot=function(cor,title=NA,mar=c(0,0,2,0)){
  corrplot.mixed(cor,title=title,upper="ellipse",cl.lim=c(-1,1),
               lower.col="black",number.cex=.8,number.font=1,
               tl.col="black",cl.cex=1,cl.length=2,mar=mar)}
```

To assess real-world correlation recovery, we re-examined the flanker and Stroop tasks in Rey-Mermet et al.'s battery of inhibition tasks.  The authors included two different types of Stroop tasks (a number Stroop and a color Stroop task, see the Appendix for details) and two different types of flanker tasks (a letter flanker and an arrow flanker task, see the Appendix for details).  The question then is about the correlation across the tasks. ^[One of the elements that makes analysis complicated is how to exclude low-performing participants.  In the previous analysis, where each task was analyzed in isolation, we retained all participants in a task who performed over 90% accuracy on that task.  In the current analysis, however, we must have the same participants for all four tasks.  We decided to retain those participants who have over 90% accuracy on all four tasks.  With this strict criterion, we retain only 180 of the original 289 participants.  The most noticeable effect of this exclusion is that the reliability for the arrow flanker task was reduced from .87 to .56.  The fact that the reliability changes so much indicates that the high reliability was driven by a few participants with very large difference scores.  This cutoff differs from @ReyMermet:etal:2018, who used a 75% accuracy.  With this lower cutoff, they included many more participants.]


```{r rm4taskFitWish,eval=runrm4WishFlag}
dat=numStroop[numStroop$cond %in% 1:2,]
N=length(dat$sub)
task=rep(1,N)
numStroopDat=cbind(dat,task)

dat=colStroop[colStroop$cond %in% 1:2,]
N=length(dat$sub)
task=rep(2,N)
colStroopDat=cbind(dat,task)

dat=letFlanker[letFlanker$cond %in% 1:2,]
N=length(dat$sub)
task=rep(3,N)
letFlankerDat=cbind(dat,task)

dat=arrowFlanker[arrowFlanker$cond %in% 1:2,]
N=length(dat$sub)
task=rep(4,N)
arrowFlankerDat=cbind(dat,task)

dat=rbind(numStroopDat,colStroopDat,letFlankerDat,arrowFlankerDat)
dat$sub=as.integer(as.factor(dat$sub))


a=(table(dat$sub,dat$task)==0) 
goodSub=!(a[,1] | a[,2] | a[,3] | a[,4]) 
dat=dat[goodSub[dat$sub],] 
dat$sub=as.integer(as.factor(dat$sub)) 
I=max(dat$sub)
mod=genModWish2(dat,M=2000)
save(file='rm4Wish.RData',dat,mod)
```

```{r rm4taskFitLKJ,eval=runrm4LKJFlag}
I=max(dat$sub)
stanLkjM <- stan_model(model_code = stanLkjC)
stanData <- list(y=dat$rt, 
                   n=length(dat$sub), I=I,J=4, 
             sub=dat$sub, cond=dat$cond, task=dat$task)
  samples <- sampling(stanLkjM, data=stanData, iter=1000, chains=1,warmup=200)
  Omega <- extract(samples)$Omega
  theta <- extract(samples)$theta
save(file='rm4LKJ.RData',Omega,theta)
```



```{r,eval=F}
mrt=tapply(dat$rt,list(dat$sub,dat$task,dat$cond),mean)
effect=(mrt[,,2]-mrt[,,1])*1000
pm=apply(mod$theta,2:3,mean)*1000
plot(effect[,2],pm[,2],typ='p',col='red',pch=19)
plot(effect[,1],pm[,1],typ='p',col='purple',pch=19,xlim=c(-100,150),ylim=c(-40,100))
points(effect[,4],pm[,4],col='green',pch=19)
points(effect[,3],pm[,3],col='blue',pch=19)
```


```{r rm4task,fig.cap="Correlations among select tasks in the Rey-Mermet data set.  Tasks are a number Stroop task, a color Stroop task, a letter flanker task, and an arrow flanker task.  Details of the tasks are provided in the Appendix.",eval=T}
load('rm4Wish.RData')
M=dim(mod$theta)[1]
cor=array(dim=c(M,4,4))
burn=0
for (m in 1:(M-burn)){
    Sigma=solve(mod$B[m+burn,,])
    cor[m,,]=cov2cor(Sigma)}
modCor=apply(cor,2:3,mean)
mrt=tapply(dat$rt,list(dat$sub,dat$task,dat$cond),mean)
effect=(mrt[,,2]-mrt[,,1])*1000
layout(matrix(nrow=2,ncol=3,1:6,byrow=T))
a=cor(effect)
names=c("NumStp","ColStrp","LetFlk","ArrFlk")
colnames(a)=names
b=spearman(dat)
colnames(b)=names
c=modCor
colnames(c)=names
myPlot(a,"A. Naive")
myPlot(b,"B. Corrected")
myPlot(c,"C. Model")
```

```{r rm4taskEst,fig.asp=1.0,fig.cap="A. Model-based posterior distributions of population correlations among tasks.  The large variance shows the difficulty of recovery.  B. Individuals' sample effects for color Stroop and arrow flanker tasks show.  C. Hierarchical model estimates show a large degree of shrinakge for arrow flankers but not for color Stroop reflecting the increased range of color Stroop effects.",eval=T}
load('rm4Wish.RData')
pm=apply(mod$theta,2:3,mean)*1000
par(cex=1.0,mar=c(4,4,1,1),mgp=c(2,1,0))
layout(matrix(nrow=2,ncol=2,byrow=T,c(1,1,2,3)))
mycol=c('black','darkred','darkblue','darkgreen','purple','brown')
c=0
plot(density(cor[,1,4]),ylim=c(0,5),xlim=c(-1,1),main="",
     axes=F,ylab="",xlab="Correlation Coefficient")
axis(1)
for (i in 1:3)
  for (j in (i+1):4){
    c=c+1
    lines(density(cor[,i,j]),col=mycol[c],lwd=2)
#    lines(density(Omega[,i,j]),col=mycol[c],lwd=2,lty=2)
  }
mtext(side=3,adj=0,cex=1.1,"A. Posterior Distributions")
legend(.5,5,fill=mycol,title="Tasks",bg="white",
       legend=c("NumStp-ColStp","NumStp-LetFlk","NumStp-ArrFlk",
                "ColStp-LetFlk","ColStp-ArrFlk","LetFlk-ArrFlk"))
myLim=c(-50,450)
plot(effect[,2],effect[,4],pch=19,
     col=rgb(0,.6,0,.2),
     ylim=myLim,xlim=myLim,
     xlab="Color Stroop Effect (ms)",
     ylab="Arrow Flanker Effect (ms)")
mtext(side=3,adj=0,cex=1.1,"B. Sample Effects")
plot(pm[,2],pm[,4],pch=19,
     col=rgb(0,0,.6,.2),
     ylim=myLim,xlim=myLim,
     xlab="Color Stroop Effect (ms)",
     ylab="Arrow Flanker Effect (ms)")
mtext(side=3,adj=0,cex=1.1,"C. Model Estimates")
#plot(effect[,4],pm[,4],pch=19,
#     col=rgb(1,0,0,.2),
#     ylim=c(-20,120),
#     xlim=c(-20,120),
#     xlab="Sample Effect (ms)",
#     ylab="Model Effect (ms)")
#abline(0,1)
```

```{r,eval=F}
load('rm4Wish.RData')
M=dim(mod$theta)[1]
I=dim(mod$theta)[2]
Sigma=cor=array(dim=c(M,4,4))
SD=matrix(nrow=M,ncol=4)
for (m in 1:M){
    Sigma[m,,]=solve(mod$B[m,,])
    SD[m,]=sqrt(diag(Sigma[m,,]))
    cor[m,,]=cov2cor(Sigma[m,,])}
modCor=apply(cor,2:3,mean)
modSD=apply(SD,2,mean)

lo=apply(cor,c(2,3),quantile,p=.025)[lower.tri(diag(4))]
hi=apply(cor,c(2,3),quantile,p=.975)[lower.tri(diag(4))]
mn=apply(cor,c(2,3),mean)[lower.tri(diag(4))]

T=length(lo)
plot(lo,1:T,typ='n',xli=c(-1,1))
arrows(lo,1:T,hi,1:T,code=3,angle=90,length=.1)


```

The top three rows of Figure \ref{fig:rm4task} show the estimated correlations from sample effects, Spearman's correction, and the hierarchical model.  Given the previous simulations results, it is hard to know how much credence to give these estimated correlations.  In particular, it is hard to know how to interpret the negative correlation between the arrow flanker and color Stroop task.  

To better understand what may be concluded about the range of correlations, we plot the posterior distribution of the correlation (Figure \ref{fig:rm4taskEst}A).  These distributions are unsettling.  The variation in most of these posteriors is so wide that firm conclusions are not possible.  The exception is the null correlation between number and color Stroop which seems to be somewhat well localized.  The surprisingly negative correlation between color Stroop and arrow flanker comes from a posterior so broad that the 95% credible interval is [`r round(quantile(cor[,2,3],p=.025),2)`,`r round(quantile(cor[,2,3],p=.975),2)`].  Here, all we can say is that very extreme correlations are not feasible.  We suspect this limited result is not news.

Analysis of @ReyMermet:etal:2018 provides an opportunity to examine how hierarchical models account for variation across trials as well as variation across people.  Figure \ref{fig:rm4taskEst}B shows sample effects across individuals for the color Stroop and arrow flanker tasks, the two tasks that were most negatively correlated.  There is a far greater degree of variation in individual's effects for the color Stroop task than for the arrow flanker task.  The model estimates (Figure \ref{fig:rm4taskEst}C) reflect this difference in variation.  The variation in arrow flanker is so small that it can be accounted for with trial variation alone.  As a result, the hierarchical model shows almost no individual variability.  In contrast, the variability in the color Stroop is large and the main contributor is true variation across individuals rather than trial variation.  Hence, there is relatively little shrinkage in model estimates. The lack of variation in the arrow flanker task gives rise to the uncertainty in the recovered correlation between the two tasks.
