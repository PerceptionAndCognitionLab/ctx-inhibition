```{r}
t.w=seq(.003,.045,length=6)/2
t.eta2=.01^2
#out=sim6(typical,t.w)
tSigma=crossprod(t(t.w))+diag(6)*t.eta2
```

We explored correlations across six tasks.  Each hypothetical data set consisted of 240,000 observations.  To generate a wide range of correlations, we used a one-factor model to simulate individuals' true scores.  This factor represents the individual's inhibition ability.   This ability, denoted $z_i$, is distributed as a standard normal.  Tasks may require more or less of the individuals' inhibition ability. Therefore, task loadings onto this factor $z_i$ are variable and, as a result, a wide range of correlations occur. The following task loading values work well in producing a diversity of correlations: `r paste(t.w[1:5]*1000,'ms, ')` and `r paste(t.w[6]*1000,'ms')`.  Following the one-factor structure we may generate true scores, $\theta_{ij}$, for each task and participant:
\[
\theta_{ij} \sim \mbox{Normal}(\mu_j+z_iw_j,\eta^2),
\]
where $z_i$ is the true ability, $w_j$ is the task loading, $\mu_j$ is the task overall mean, and $\eta^2$ is residual variability in addition to that from the factors.  In simulation we set $\eta=10$ ms, and this setting yields standard deviations across $\theta_{ij}$ between 10 ms and 30 ms, which is similar to the 25 ms value used previously.  The true population variance for the one-factor model is $\bfSigma = \bfw\bfw' + \bfI\eta^2$, where $\bfw\bfw'$ is the matrix formed by the outer product of the task loadings.  The true correlation matrix from the variance-covariance matrix $\bfSigma$ is shown in Figure \ref{fig:cov6}A, and the values subtend a large range from near zero to `r round(cov2cor(tSigma)[5,6],2)`.    




```{r sixTaskRun, eval=sim6Flag}
observed=function(dat){
         mrt=tapply(dat$rt,list(dat$sub,dat$task,dat$cond),mean)
        effect=mrt[,,2]-mrt[,,1]
        return(cor(effect))}

R=2
result=array(dim=c(R,5,6,6))
set.seed(789)
M=300
burn=100
cor=array(dim=c(R,M-burn,6,6))
for (r in 1:R){
  out=sim6(typical,t.w)
  dat=out$dat
  t.theta=out$t.theta
  result[r,1,,]=cor(t.theta)
  result[r,2,,]=observed(dat)
  result[r,3,,]=spearman(dat)
  mod=genModWish2(dat,M=M)
  for (m in 1:(M-burn)){
    Sigma=solve(mod$B[m+burn,,])
    cor[r,m,,]=cov2cor(Sigma)}
  result[r,4,,]=apply(cor[r,,,],2:3,mean)
}
save(result,file='sixTaskSimResults.RData')
```

```{r cov6,fig.cap="True and recovered correlation matrices for six tasks.  A: True population correlations. B-D: Correlation estimates from a single run."}
load(file="sixTaskSimResults.RData")
cor.theta=result[1,1,,]
cor.naive=result[1,2,,]
cor.correct=result[1,3,,]
cor.model=result[1,4,,]

myPlot=function(cor,title=NA,mar=c(0,0,2,0)){
corrplot.mixed(cor,title=title,upper="ellipse",cl.lim=c(-1,1),
               lower.col="black",number.cex=.8,number.font=1,
               tl.col="black",cl.cex=1,cl.length=2,mar=mar)}


layout(matrix(nrow=2,ncol=2,byrow=T,c(1,2,3,4)))
myPlot(cov2cor(tSigma),'A. Population')
#myPlot(cor.theta,'B. True Individual')
myPlot(cor.naive,'B. Sample')
cor.correct=ifelse(cor.correct>1,1,cor.correct)
cor.correct=ifelse(cor.correct< -1,-1,cor.correct)

myPlot(cor.correct,'C. Spearman')
myPlot(cor.model,'D. Model')

```

```{r recov6,fig.cap="Recovery of correlations from six tasks.  True correlations are derived from a one-factor model and are displayed in Figure \\ref{fig:cov6}."}
load(file="sixTaskSimResults.RData")
R=dim(result)[1]

good=rep(as.vector(lower.tri(diag(6))),each=R)

true=as.vector(cov2cor(tSigma)[lower.tri(diag(6))])
tI=seq(1,45,3)
trueIndx=rep(tI,each=R)

rest=cbind(as.vector(result[,2,,])[good],
           as.vector(result[,3,,])[good],
           as.vector(result[,4,,])[good])

#correct for negative reliabilities 
rest[is.na(rest[,2]),2]=sign(rest[is.na(rest[, 2]),1])
rest[rest[,2]>1,2]=1

plot(trueIndx,rest[,1],pch=myPch[1],col=myCol[1],
     ylim=c(-1,1),xlim=c(0,46),axes=F,xlab="",ylab="Correlation")
points(trueIndx+.5,rest[,2],pch=myPch[2],col=myCol[2])
points(trueIndx+1,rest[,3],pch=myPch[3],col=myCol[3])
axis(2)
legend(26,-.15,legend=c("Sample","Spearman","Model"),pch=myPch,col=myColSat,bg="white")
segments(tI-.25,true,tI+1.5,true,lwd=2)
```



The recovery of correlations is shown for a single simulation run in Figure \ref{fig:cov6}B-D.  The attenuation for the sample correlations is evident, as is variability in model-based and Spearman corrected estimates.  Figure \ref{fig:recov6} shows the performance of the methods across the `r dim(result)[1]` simulation runs.  
As can be seen, there remains the dramatic attenuation for the sample correlation of sample effects and excessive variability for the Spearman-corrected and model-based correlation estimates.  Spearman corrected estimates are free to be outside the valid range from -1 to 1.  We imagine that any researcher encountering these values could justifiably set them to the appropriate endpoint, and we do so in Figure \ref{fig:recov6}.  Nonetheless, the RMS errors remain high---across the whole range of true values they are `r round(rmse(rep(true,each=R),rest[,2]),2)` and `r round(rmse(rep(true,each=R),rest[,3]),2)` for the Spearman correlation and model, respectively.  It is somewhat heartening that model recovery is somewhat informative. 

